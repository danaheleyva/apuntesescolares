<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Apuntes Escolares</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- SDK Supabase (v2). 'defer' para que esté listo antes de nuestro script -->
  <script defer src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{--bg:#0f172a;--card:#111827;--muted:#9ca3af;--text:#e5e7eb;--accent:#22d3ee;--accent2:#38bdf8;--err:#f43f5e;--ok:#22c55e}
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0b1023,#0f172a);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
    header,footer{border-color:rgba(255,255,255,.08)}
    header{position:sticky;top:0;background:rgba(15,23,42,.75);backdrop-filter:blur(6px);border-bottom:1px solid}
    .wrap{max-width:1100px;margin:0 auto;padding:1rem}
    .brand{font-weight:800}
    nav a{color:var(--text);opacity:.9;text-decoration:none;margin-right:1rem}
    .grid{display:grid;gap:1rem}
    .card{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.07);border-radius:14px;padding:1rem}
    input,select,button{border-radius:10px;border:1px solid rgba(255,255,255,.1);background:#0b1023;color:var(--text);padding:.6rem .8rem}
    button{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#00202a;border:none;font-weight:800;cursor:pointer}
    .pill{display:inline-block;border:1px solid rgba(255,255,255,.15);border-radius:999px;padding:.2rem .6rem;font-size:.75rem;color:var(--muted)}
    .flex{display:flex;gap:.6rem;align-items:center;flex-wrap:wrap}
    .right{margin-left:auto}
    .doc{display:grid;grid-template-columns:1fr auto;gap:.6rem;align-items:center;border-top:1px solid rgba(255,255,255,.06);padding:.7rem 0}
    .muted{color:var(--muted)} .err{color:var(--err)} .ok{color:var(--ok)} .hide{display:none}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
    @media(max-width:880px){.two{grid-template-columns:1fr}}
  </style>
</head>
<body>
<header>
  <div class="wrap flex">
    <div class="brand">Apuntes Escolares</div>
    <nav class="right">
      <a href="#home" onclick="ui.show('home')">Inicio</a>
      <a href="#upload" onclick="ui.show('upload')">Subir</a>
      <a href="#mine" onclick="ui.show('mine')">Mis subidas</a>
      <a id="nav-mod" href="#mod" onclick="ui.show('moderation')" class="hide">Moderación</a>
    </nav>
  </div>
</header>

<main class="wrap grid">
  <!-- LOGIN -->
  <section class="card" id="loginBox">
    <h2>Entrar</h2>
    <div class="two">
      <div>
        <h3>Como usuario</h3>
        <div class="grid">
          <input id="email" type="email" placeholder="tu@email.com">
          <input id="password" type="password" placeholder="Contraseña (mín. 8 caracteres)">
          <div class="flex">
            <button id="btnLogin">Entrar</button>
            <button id="btnSignup">Crear cuenta</button>
            <button id="btnReset">Olvidé mi contraseña</button>
          </div>
          <small class="muted">O entra con enlace mágico (sin contraseña):</small>
          <button id="btnMagic">Enviar enlace de acceso</button>
        </div>
      </div>
      <div>
        <h3>Como moderador</h3>
        <div class="grid">
          <button id="btnGoMod">Ir al panel de moderación</button>
          <small class="muted">Necesitas una cuenta con permisos de moderador.</small>
        </div>
      </div>
    </div>
    <div class="flex muted" style="margin-top:.5rem">
      <span class="pill">También puedes navegar como invitado (ver documentos y comentarios).</span>
      <span class="right" id="whoami">Invitado</span>
    </div>
    <div id="sdkError" class="err hide"></div>
  </section>

  <!-- HOME -->
  <section class="card" id="home">
    <h2>Documentos aprobados</h2>
    <div id="docsList" class="grid" style="margin-top:.8rem">Cargando…</div>
  </section>

  <!-- SUBIR -->
  <section class="card hide" id="upload">
    <h2>Subir documento (queda pendiente de aprobación)</h2>
    <div class="grid">
      <input id="u_title" placeholder="Título" />
      <input id="u_author" placeholder="Tu nombre (autor)" />
      <input id="u_email" placeholder="Tu correo (para notificaciones)" />
      <div class="two">
        <select id="u_cat">
          <option value="">Selecciona tu carrera</option>
          <option>Ingeniería Civil</option><option>Ingeniería Geomática</option><option>Ingeniería Eléctrica Electrónica</option>
          <option>Ingeniería en Computación</option><option>Ingeniería en Telecomunicaciones</option><option>Ingeniería Mecánica</option>
          <option>Ingeniería Industrial</option><option>Ingeniería Mecatrónica</option><option>Ingeniería en Sistemas Biomédicos</option>
        </select>
        <input id="u_tags" placeholder="Etiquetas separadas por coma (ej. Cálculo, Integrales)" />
      </div>
      <input id="u_file" type="file" accept=".pdf,.doc,.docx,.ppt,.pptx,.png,.jpg,.jpeg" />
      <div class="flex">
        <button id="btnUpload">Enviar</button>
        <span id="u_msg" class="muted"></span>
      </div>
    </div>
  </section>

  <!-- MIS SUBIDAS -->
  <section class="card hide" id="mine">
    <h2>Mis subidas</h2>
    <div id="mineList" class="grid"></div>
  </section>

  <!-- MODERACIÓN -->
  <section class="card hide" id="moderation">
    <h2>Moderación – Pendientes</h2>
    <div id="modWarn" class="err"></div>
    <div id="queue" class="grid"></div>
  </section>
</main>

<footer>
  <div class="wrap flex">
    <span class="muted">© 2025 Apuntes Escolares</span>
    <div class="right flex">
      <button id="btnLogout">Salir</button>
    </div>
  </div>
</footer>

<script>
/* ====== CONFIG ====== */
const SUPABASE_URL = "https://msoeeamotfajcpodnxif.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1zb2VlYW1vdGZhamNwb2RueGlmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0MjA2NDgsImV4cCI6MjA3ODk5NjY0OH0.fCas1O8XLgWwYww0l99VThswjWwlo_rGDOpMJ5Z_GXk";
const BUCKET = "DOCS";
const REDIRECT_URL = window.location.origin + window.location.pathname;

const qs = s => document.querySelector(s);
const show = (id, yes) => qs('#'+id).classList.toggle('hide', !yes);
const ui = {
  show(id){
    ["home","upload","mine","moderation"].forEach(x => show(x, x===id));
    if(id==="home") pages.search();
    if(id==="mine") pages.mine();
    if(id==="moderation") pages.queue();
  }
};

/* ====== Arranque defensivo del SDK ====== */
let supabase;
function sdkFail(msg){
  const box = qs("#sdkError");
  box.textContent = msg;
  box.classList.remove("hide");
  console.error(msg);
}
(function ensureSDK(){
  if (!window.supabase || !window.supabase.createClient) {
    sdkFail("No se pudo cargar el SDK de Supabase. Revisa tu conexión o si el CDN está bloqueado. (window.supabase no existe)");
    return;
  }
  try {
    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    console.log("Supabase SDK OK");
  } catch (e) {
    sdkFail("Error creando cliente de Supabase: " + e.message);
  }
})();

/* ====== AUTH ====== */
const auth = {
  user: null,
  isModerator: false,

  async loadUser(){
    if(!supabase) return;
    const { data: { user } } = await supabase.auth.getUser();
    this.user = user || null;
    this.isModerator = !!(user && user.app_metadata && user.app_metadata.is_moderator);

    // UI: quién soy y visibilidad
    qs("#whoami").textContent = user
      ? `Conectado: ${user.email}${this.isModerator?" · MOD":""}`
      : "Invitado";
    // Oculta "Entrar" si hay sesión
    qs("#loginBox").classList.toggle("hide", !!user);
    // Muestra "Moderación" en nav si eres MOD
    qs("#nav-mod").classList.toggle("hide", !this.isModerator);
  },

  async signInPw(){
    if(!supabase) return alert("Supabase no está listo.");
    const email = qs("#email").value.trim();
    const password = qs("#password").value;
    if(!email || !password) return alert("Correo y contraseña son obligatorios.");
    const { error } = await supabase.auth.signInWithPassword({ email, password });
    if (error) { alert(error.message); return; }
    await this.loadUser();
    ui.show("home");
  },

  async signUpPw(){
    if(!supabase) return alert("Supabase no está listo.");
    const email = qs("#email").value.trim();
    const password = qs("#password").value;
    if(!email || !password) return alert("Correo y contraseña son obligatorios.");
    const { error } = await supabase.auth.signUp({
      email, password,
      options: { emailRedirectTo: REDIRECT_URL } // por si luego vuelves a activar confirmación
    });
    if (error) return alert(error.message);
    alert("Cuenta creada. Ya puedes entrar con tu correo y contraseña.");
  },

  async resetPw(){
    if(!supabase) return alert("Supabase no está listo.");
    const email = qs("#email").value.trim();
    if(!email) return alert("Escribe tu correo.");
    const { error } = await supabase.auth.resetPasswordForEmail(email, { redirectTo: REDIRECT_URL + "#reset" });
    if (error) return alert(error.message);
    alert("Te envié un correo para restablecer tu contraseña.");
  },

  async magicLink(){
    if(!supabase) return alert("Supabase no está listo.");
    const email = qs("#email").value.trim();
    if(!email) return alert("Escribe tu correo.");
    const { error } = await supabase.auth.signInWithOtp({
      email, options: { emailRedirectTo: REDIRECT_URL }
    });
    if (error) return alert(error.message);
    alert("Te envié un enlace de acceso. Revisa tu correo y vuelve.");
  },

  openModerator(){
    if (!this.isModerator) { alert("No tienes permisos de moderador."); return; }
    ui.show("moderation");
    qs("#modWarn").textContent = "";
  },

  async signOut(){
    if(!supabase) return;
    await supabase.auth.signOut();
    await this.loadUser();
    ui.show("home");
  }
};
window.auth = auth; // por si quieres llamar desde consola

// Cambios de sesión (incluye recuperación de contraseña)
supabase?.auth.onAuthStateChange(async (event) => {
  console.log("auth event:", event);
  if (event === "PASSWORD_RECOVERY") {
    const newPass = prompt("Escribe tu nueva contraseña:");
    if (newPass) {
      const { error } = await supabase.auth.updateUser({ password: newPass });
      if (error) alert(error.message);
      else alert("Contraseña actualizada. Vuelve a entrar con ella.");
    }
  }
  await auth.loadUser();
});

/* ====== PÁGINAS (versión mínima para esta prueba) ====== */
const pages = {
  async search(){
    if(!supabase){ qs("#docsList").textContent = "SDK no disponible."; return; }
    const { data, error } = await supabase.from("documents")
      .select("*").eq("status","approved").order("created_at",{ascending:false});
    const box = qs("#docsList");
    if (error) { box.textContent = "Error cargando documentos."; return; }
    if (!data || !data.length) { box.textContent = "No hay documentos."; return; }
    box.innerHTML = "";
    data.forEach(d=>{
      const row = document.createElement("div"); row.className="doc";
      const left = document.createElement("div"); left.innerHTML =
        `<div>${d.title}</div>
         <div class="muted">${d.author_name||'Anónimo'} · ${d.category||''} · ${d.ext||''}</div>`;
      const { data:pub } = supabase.storage.from(BUCKET).getPublicUrl(d.storage_path);
      const right = document.createElement("div"); right.innerHTML = `<a href="${pub.publicUrl}" download>Descargar</a>`;
      row.append(left,right);
      box.append(row);
    });
  },
  async mine(){ /* … (igual que antes) … */ },
  async queue(){ /* … (igual que antes) … */ }
};

/* ====== SUBIDA ====== */
async function doUpload(){
  if(!supabase) return alert("Supabase no está listo.");
  if(!auth.user) return alert("Inicia sesión para subir.");
  const file = qs("#u_file").files[0];
  const title = qs("#u_title").value.trim();
  if(!title || !file) return alert("Falta título o archivo.");
  if(file.size > 5*1024*1024) return alert("Máximo 5 MB.");

  qs("#u_msg").textContent = "Subiendo…";
  const path = `pending/${auth.user.id}/${Date.now()}-${file.name}`;
  const { error: e1 } = await supabase.storage.from(BUCKET).upload(path, file, { upsert:false });
  if (e1) { qs("#u_msg").textContent = "Error al subir: " + e1.message; return; }

  const ext = (file.name.split(".").pop()||"").toLowerCase();
  const category = qs("#u_cat").value || "";
  const tags = qs("#u_tags").value.split(",").map(s=>s.trim()).filter(Boolean);
  const author = qs("#u_author").value.trim();
  const email  = qs("#u_email").value.trim();

  const { error: e2 } = await supabase.from("documents").insert({
    owner: auth.user.id, title, author_name: author, email, category, tags,
    ext, storage_path: path, size_bigint: file.size, status:'pending'
  });
  if (e2) { qs("#u_msg").textContent = "Error guardando metadatos: " + e2.message; return; }

  qs("#u_msg").textContent = "Listo. Quedó como pendiente.";
  qs("#u_title").value = qs("#u_author").value = qs("#u_email").value = qs("#u_tags").value = "";
  qs("#u_file").value = "";
}

/* ====== Listeners (sin inline) ====== */
document.addEventListener("DOMContentLoaded", () => {
  // botones auth
  qs("#btnLogin").addEventListener("click", () => auth.signInPw());
  qs("#btnSignup").addEventListener("click", () => auth.signUpPw());
  qs("#btnReset").addEventListener("click", () => auth.resetPw());
  qs("#btnMagic").addEventListener("click", () => auth.magicLink());
  qs("#btnGoMod").addEventListener("click", () => auth.openModerator());
  qs("#btnLogout").addEventListener("click", () => auth.signOut());

  // subir
  qs("#btnUpload").addEventListener("click", () => doUpload());
});

/* ====== INIT ====== */
(async function init(){
  await auth.loadUser();   // oculta “Entrar” si ya hay sesión
  ui.show("home");
  pages.search();
})();
</script>
</body>
</html>



