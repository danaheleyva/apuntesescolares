<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Apuntes Escolares</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    /* === PALETA DE COLORES UNAM (Azul y Oro) === */
    :root {
      --unam-blue: #002B7A;       /* Azul UNAM principal */
      --unam-dark: #001C4D;       /* Azul m√°s oscuro para fondo */
      --unam-gold: #D59F0F;       /* Dorado UNAM */
      --unam-gold-light: #F2C75C; /* Dorado brillo */
      --white: #ffffff;
      --gray-light: #f3f4f6;
      --text-dark: #111827;       
      --err: #ef4444;
      --ok: #16a34a;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      /* Degradado Azul UNAM */
      background: linear-gradient(135deg, var(--unam-dark) 0%, var(--unam-blue) 100%);
      color: var(--text-dark);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      min-height: 100vh;
    }

    /* === HEADER === */
    header {
      position: sticky;
      top: 0;
      background: rgba(0, 28, 77, 0.95);
      backdrop-filter: blur(8px);
      border-bottom: 3px solid var(--unam-gold);
      z-index: 10;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
      color: var(--white);
    }
    
    .wrap { max-width: 1100px; margin: 0 auto; padding: 1rem; }
    .flex { display: flex; gap: 0.8rem; align-items: center; flex-wrap: wrap; }
    .right { margin-left: auto; }
    .grid { display: grid; gap: 1rem; }

    .brand { font-weight: 900; font-size: 1.2rem; letter-spacing: 0.5px; color: var(--unam-gold); }
    
    nav a { 
      color: var(--white); opacity: 0.9; text-decoration: none; margin-right: 1rem; font-weight: 500; transition: color 0.2s;
    }
    nav a:hover { color: var(--unam-gold); opacity: 1; }

    /* === TARJETAS === */
    .card {
      background: var(--white);
      border-radius: 12px;
      padding: 2rem;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      border: 1px solid rgba(255,255,255,0.1);
      margin-top: 1rem;
    }

    h1, h2, h3 { margin-top: 0; color: var(--unam-blue); }

    /* === INPUTS Y BOTONES === */
    input, select, textarea {
      width: 100%; border-radius: 8px; border: 1px solid #d1d5db; background: #fff;
      color: var(--text-dark); padding: 0.75rem 1rem; font-size: 1rem;
    }
    input:focus, select:focus { outline: none; border-color: var(--unam-blue); box-shadow: 0 0 0 3px rgba(0, 43, 122, 0.1); }

    button {
      background: linear-gradient(90deg, var(--unam-gold), var(--unam-gold-light));
      color: var(--unam-dark); border: none; border-radius: 8px; padding: 0.75rem 1.2rem;
      font-weight: 700; cursor: pointer; text-transform: uppercase; font-size: 0.9rem;
    }
    button:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(213, 159, 15, 0.4); }
    
    button.ghost { background: transparent; border: 1px solid var(--unam-blue); color: var(--unam-blue); }
    
    /* === UTILIDADES === */
    .pill { display: inline-block; background: var(--gray-light); border-radius: 999px; padding: 0.25rem 0.75rem; font-size: 0.8rem; color: var(--unam-dark); font-weight: 600; }
    .stars { font-size: 1.2rem; cursor: pointer; user-select: none; }
    .star-on { color: var(--unam-gold); }
    .star-off { color: #d1d5db; }
    .doc { display: grid; grid-template-columns: 1fr auto; gap: 0.8rem; align-items: center; border-top: 1px solid #e5e7eb; padding: 1rem 0; }
    .muted { color: #6b7280; font-size: 0.9rem; }
    .err { color: var(--err); } .ok { color: var(--ok); } 
    .hide { display: none !important; }
    
    .two { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
    @media(max-width: 800px) { .two { grid-template-columns: 1fr; } }

    /* Login Centrado */
    #loginBox { max-width: 500px; margin: 2rem auto; text-align: center; border-top: 5px solid var(--unam-gold); }
    #loginBox button { width: 100%; margin-top: 0.5rem; }
  </style>
</head>

<body>
<header>
  <div class="wrap flex">
    <div class="brand">Apuntes Escolares</div>
    <nav class="right">
      <a href="#home" onclick="ui.show('home')">Inicio</a>
      <a href="#upload" onclick="ui.show('upload')">Subir</a>
      <a href="#mine" onclick="ui.show('mine')">Mis subidas</a>
      <a id="nav-mod" href="#moderation" onclick="ui.show('moderation')" class="hide">Moderaci√≥n</a>
    </nav>
  </div>
</header>

<main class="wrap grid">
  <section class="card" id="loginBox">
    <h2>Iniciar Sesi√≥n</h2>
    <p class="muted" style="margin-bottom: 1.5rem;">Accede para subir y comentar documentos</p>
    
    <div class="grid">
      <input id="email" type="email" placeholder="Correo electr√≥nico" />
      <input id="password" type="password" placeholder="Contrase√±a" />
      
      <button id="btn-login">Entrar</button>
      
      <div style="margin-top: 1rem; display:grid; gap:0.5rem">
        <button id="btn-signup" class="ghost">Crear cuenta nueva</button>
        <button id="btn-magic" class="ghost" style="font-size:0.8rem">Enviar enlace m√°gico (sin contrase√±a)</button>
        <small class="muted" style="cursor:pointer; text-decoration:underline;" onclick="authActions.resetPw()">Olvid√© mi contrase√±a</small>
      </div>
    </div>
    <div class="flex muted" style="margin-top:1.5rem; justify-content:center;">
      <span class="pill">Los invitados pueden buscar y ver documentos.</span>
    </div>
  </section>

  <section class="card" id="home">
    <h2>Documentos aprobados</h2>
    <div class="two">
      <div class="grid">
        <input id="f_q" placeholder="Buscar por t√≠tulo o autor‚Ä¶" oninput="pages.search()" />
        <div class="flex">
          <select id="f_cat" onchange="pages.search()">
            <option value="">Todas las carreras</option>
            <option>Ingenier√≠a Civil</option><option>Ingenier√≠a Geom√°tica</option><option>Ingenier√≠a El√©ctrica Electr√≥nica</option>
            <option>Ingenier√≠a en Computaci√≥n</option><option>Ingenier√≠a en Telecomunicaciones</option><option>Ingenier√≠a Mec√°nica</option>
            <option>Ingenier√≠a Industrial</option><option>Ingenier√≠a Mecatr√≥nica</option><option>Ingenier√≠a en Sistemas Biom√©dicos</option>
          </select>
          <select id="f_ext" onchange="pages.search()">
            <option value="">Extensi√≥n</option><option>pdf</option><option>docx</option><option>pptx</option><option>png</option><option>jpg</option>
          </select>
          <select id="f_order" onchange="pages.search()">
            <option value="created_at.desc">M√°s recientes</option>
            <option value="avg_rating.desc">Mejor calificados</option>
            <option value="title.asc">A - Z</option>
          </select>
        </div>
      </div>
      <div class="grid">
        <input id="f_tags" placeholder="Etiquetas (coma , )" oninput="pages.search()" />
        <div class="flex">
          <label class="muted">Desde</label><input type="date" id="f_from" onchange="pages.search()" style="width:auto" />
          <label class="muted">Hasta</label><input type="date" id="f_to" onchange="pages.search()" style="width:auto" />
        </div>
      </div>
    </div>
    <div id="docsList" class="grid" style="margin-top:.8rem"></div>
  </section>

  <section class="card hide" id="upload">
    <h2>Subir documento</h2>
    <div class="grid">
      <input id="u_title" placeholder="T√≠tulo" />
      <input id="u_author" placeholder="Tu nombre (autor)" />
      <input id="u_email" placeholder="Tu correo (para notificaciones)" />
      <div class="two">
        <select id="u_cat">
          <option value="">Selecciona tu carrera</option>
          <option>Ingenier√≠a Civil</option><option>Ingenier√≠a Geom√°tica</option><option>Ingenier√≠a El√©ctrica Electr√≥nica</option>
          <option>Ingenier√≠a en Computaci√≥n</option><option>Ingenier√≠a en Telecomunicaciones</option><option>Ingenier√≠a Mec√°nica</option>
          <option>Ingenier√≠a Industrial</option><option>Ingenier√≠a Mecatr√≥nica</option><option>Ingenier√≠a en Sistemas Biom√©dicos</option>
        </select>
        <input id="u_tags" placeholder="Etiquetas (ej. C√°lculo, Integrales)" />
      </div>
      <input id="u_file" type="file" accept=".pdf,.doc,.docx,.ppt,.pptx,.png,.jpg,.jpeg" />
      <div class="flex">
        <button id="btn-upload">Enviar a revisi√≥n</button>
        <span id="u_msg" class="muted" style="color:var(--unam-blue); font-weight:bold;"></span>
      </div>
    </div>
  </section>

  <section class="card hide" id="mine">
    <h2>Mis subidas</h2>
    <div id="mineList" class="grid"></div>
  </section>

  <section class="card hide" id="moderation" style="border-top: 5px solid var(--err);">
    <h2>Moderaci√≥n ‚Äì Pendientes</h2>
    <div id="modWarn" class="err"></div>
    <div id="queue" class="grid"></div>
  </section>

  <section class="card hide" id="notif">
    <h2>Notificaciones</h2>
    <div id="notifList" class="grid"></div>
  </section>
</main>

<footer>
  <div class="wrap flex">
    <span style="color:rgba(255,255,255,0.7)">¬© 2025 Apuntes Escolares ¬∑ UNAM üíôüíõ</span>
    <div class="right flex">
      <button id="btn-logout" class="hide" style="background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.3); color:white;">Salir</button>
    </div>
  </div>
</footer>

<script>
/**
 * ==========================================
 * CONFIGURACI√ìN DE SUPABASE
 * ==========================================
 */
const SUPABASE_URL = "https://msoeeamotfajcpodnxif.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1zb2VlYW1vdGZhamNwb2RueGlmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0MjA2NDgsImV4cCI6MjA3ODk5NjY0OH0.fCas1O8XLgWwYww0l99VThswjWwlo_rGDOpMJ5Z_GXk";
const BUCKET = "DOCS";

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
  auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
});

/*** HELPERS UI ***/
const qs = s => document.querySelector(s);
const el = (t,a={},c=[])=>{const n=document.createElement(t);Object.entries(a).forEach(([k,v])=>(k in n)?n[k]=v:n.setAttribute(k,v));(Array.isArray(c)?c:[c]).filter(Boolean).forEach(x=>n.append(x.nodeType?x:document.createTextNode(x)));return n;}

const ui = {
  show(id){
    ["home","upload","mine","moderation","notif"].forEach(x => qs("#"+x).classList.add("hide"));
    const target = qs("#"+id);
    if(target) target.classList.remove("hide");

    if(id==="home") pages.search();
    if(id==="mine") pages.mine();
    if(id==="moderation") pages.queue();
    if(id==="notif") pages.notif();
  },
  
  stars(avg){ const n=Math.round(avg||0); return "‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ".split("").map((s,i)=> el("span",{className: i<n?"star-on":"star-off"}, s)); },
  
  // === L√ìGICA DE ESTADO (TU VERSI√ìN CORRECTA) ===
  renderAuth(user, isModerator){
    // 1. LOGIN BOX: Ocultar si hay usuario, mostrar si no
    qs("#loginBox").classList.toggle("hide", !!user);
    
    // 2. BOT√ìN SALIR: Solo si hay usuario
    qs("#btn-logout").classList.toggle("hide", !user);

    // 3. MEN√ö: Ocultar enlaces de escritura a invitados
    const navUpload = qs("nav a[href='#upload']");
    const navMine = qs("nav a[href='#mine']");
    if(navUpload) navUpload.classList.toggle("hide", !user);
    if(navMine) navMine.classList.toggle("hide", !user);
    
    // Moderaci√≥n solo mods
    qs("#nav-mod").classList.toggle("hide", !isModerator);

    // 4. IDENTIDAD EN BARRA SUPERIOR
    let label = qs("#user-identity");
    if(!label){
      label = document.createElement("span");
      label.id = "user-identity";
      label.style.cssText = "font-size:0.9rem; margin-right:1rem; color:white; opacity:0.9;";
      const nav = qs("nav");
      nav.insertBefore(label, nav.firstChild);
    }

    if (user) {
      label.innerHTML = `${user.email} ${isModerator ? '<span style="background:var(--unam-gold); color:black; padding:2px 6px; border-radius:4px; font-size:0.7rem; font-weight:bold;">MOD</span>' : ''}`;
    } else {
      label.innerHTML = `<span style="opacity:0.7">Invitado (Solo lectura)</span>`;
    }
  }
};

/*** GESTI√ìN DE ESTADO ***/
const state = {
  user: null,
  isModerator: false,

  async init(){
    const { data: { session } } = await supabase.auth.getSession();
    this.updateState(session);
    supabase.auth.onAuthStateChange((_event, session) => {
      this.updateState(session);
    });
  },

  updateState(session){
    this.user = session?.user || null;
    this.isModerator = !!(this.user?.app_metadata?.is_moderator);
    console.log("Auth:", { email: this.user?.email, isMod: this.isModerator });
    ui.renderAuth(this.user, this.isModerator);
  }
};

/*** ACCIONES AUTH ***/
const REDIRECT_URL = window.location.origin + window.location.pathname;

const authActions = {
  async signInPw(){
    const email = qs("#email").value.trim();
    const password = qs("#password").value.trim();
    if(!email || !password) return alert("Falta correo o contrase√±a.");
    const { error } = await supabase.auth.signInWithPassword({ email, password });
    if(error) alert(error.message);
    else ui.show("home");
  },

  async signUpPw(){
    const email = qs("#email").value.trim();
    const password = qs("#password").value.trim();
    if(!email || !password) return alert("Falta correo o contrase√±a.");
    const { error } = await supabase.auth.signUp({
      email, password, options: { emailRedirectTo: REDIRECT_URL }
    });
    if(error) alert(error.message);
    else alert("Cuenta creada. Intenta iniciar sesi√≥n (o revisa tu correo si est√° activada la confirmaci√≥n).");
  },

  async magicLink(){
    const email = qs("#email").value.trim();
    if(!email) return alert("Escribe tu correo.");
    const { error } = await supabase.auth.signInWithOtp({
      email, options: { emailRedirectTo: REDIRECT_URL }
    });
    if(error) alert(error.message);
    else alert("Enlace enviado a tu correo.");
  },

  async resetPw(){
    const email = qs("#email").value.trim();
    if(!email) return alert("Ingresa tu correo arriba.");
    const { error } = await supabase.auth.resetPasswordForEmail(email, { redirectTo: REDIRECT_URL });
    if(error) alert(error.message);
    else alert("Correo de recuperaci√≥n enviado.");
  },

  async signOut(){
    await supabase.auth.signOut();
    ui.show("home");
    alert("Has cerrado sesi√≥n.");
  }
};

/*** P√ÅGINAS ***/
const pages = {
  async search(){
    const q = qs("#f_q").value.trim();
    const cat = qs("#f_cat").value;
    const ext = qs("#f_ext").value;
    const tags = qs("#f_tags").value.split(",").map(s=>s.trim()).filter(Boolean);
    const order = qs("#f_order").value || "created_at.desc";
    const [col, dir] = order.split(".");

    let req = supabase.from("documents").select("*").eq("status","approved");
    if(q) req = req.or(`title.ilike.%${q}%,author_name.ilike.%${q}%`);
    if(cat) req = req.eq("category", cat);
    if(ext) req = req.eq("ext", ext);
    if(tags.length) req = req.contains("tags", tags);
    
    const from = qs("#f_from").value, to = qs("#f_to").value;
    if(from) req = req.gte("created_at", from);
    if(to) req = req.lte("created_at", to + " 23:59:59");

    req = req.order(col, { ascending: dir === "asc" });

    const { data, error } = await req;
    const box = qs("#docsList"); box.innerHTML = "";
    if(error) { box.textContent = "Error al cargar."; return; }
    if(!data?.length) { box.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:2rem; color:#6b7280;">No se encontraron documentos.</div>'; return; }

    data.forEach(d => box.append(render.docCard(d, { public: true })));
  },

  async mine(){
    if(!state.user) return qs("#mineList").textContent = "Debes iniciar sesi√≥n.";
    const { data } = await supabase.from("documents").select("*").eq("owner", state.user.id).order("created_at",{ascending:false});
    const box = qs("#mineList"); box.innerHTML = "";
    if(!data?.length) return box.textContent = "No has subido documentos.";
    data.forEach(d => box.append(render.docCard(d,{mine:true})));
  },

  async queue(){
    const box = qs("#queue"); box.innerHTML = "";
    if(!state.isModerator) return box.textContent = "Acceso denegado.";
    const { data } = await supabase.from("documents").select("*").eq("status","pending").order("created_at",{ascending:true});
    if(!data?.length) return box.textContent = "No hay pendientes.";
    data.forEach(d => box.append(render.modCard(d)));
  },

  async notif(){
    if(!state.user) return qs("#notifList").textContent = "Inicia sesi√≥n.";
    const { data } = await supabase.from("notifications").select("*").eq("user_id", state.user.id).order("created_at",{ascending:false});
    const box = qs("#notifList"); box.innerHTML = "";
    if(!data?.length) return box.textContent = "Sin notificaciones.";
    data.forEach(n => {
      const row = el("div", {className:"doc"}, [
        el("div", {}, [
          el("div", {style:"font-weight:bold"}, n.type === 'accepted' ? "‚úÖ Aprobado" : "‚ùå Rechazado"),
          el("div", {className:"muted"}, n.message)
        ]),
        el("div", {className:"muted"}, new Date(n.created_at).toLocaleDateString())
      ]);
      box.append(row);
    });
  }
};

/*** RENDER ***/
const render = {
  docCard(d, opts={}){
    const row = el("div",{className:"doc"});
    const { data: pub } = supabase.storage.from(BUCKET).getPublicUrl(d.storage_path);
    
    const left = el("div",{},[
      el("div",{style:"font-weight:700;font-size:1.1rem; color:var(--unam-blue)"}, d.title),
      el("div",{className:"muted"}, `${d.author_name||'An√≥nimo'} ‚Ä¢ ${d.category||'Gral'} ‚Ä¢ ${d.ext.toUpperCase()}`),
      el("div",{className:"pill", style:"margin-top:0.4rem; background:#eff6ff; color:var(--unam-blue);"}, d.tags?.join(", ") || "Sin etiquetas")
    ]);

    const actions = el("div",{className:"grid", style:"justify-items:end; gap:0.5rem"});
    if(d.status === 'approved' || opts.mine){
      actions.append(el("a", {href: pub.publicUrl, target:"_blank", className:"pill", style:"background:var(--unam-gold); color:black; text-decoration:none; cursor:pointer;"}, "‚¨á Descargar"));
    }
    
    const starsDiv = el("div", {className:"stars"}, ui.stars(d.avg_rating));
    if(state.user && d.status === 'approved'){
      starsDiv.onclick = async (e) => {
        const idx = Array.from(e.currentTarget.children).indexOf(e.target);
        if(idx === -1) return;
        await supabase.from("ratings").upsert({ doc_id: d.id, user_id: state.user.id, stars: idx + 1 });
        pages.search();
      };
    }
    actions.append(starsDiv);
    row.append(left, actions);

    if(opts.mine){
      let color = d.status === 'approved' ? 'var(--ok)' : (d.status==='rejected'?'var(--err)':'var(--unam-gold)');
      let text = d.status === 'approved' ? 'Aprobado' : (d.status==='rejected'?'Rechazado':'En Revisi√≥n');
      row.append(el("div", {style:`grid-column:1/-1; font-weight:bold; color:${color}; font-size:0.9rem`}, 
        `Estado: ${text} ${d.reject_reason ? `(Motivo: ${d.reject_reason})` : ''}`
      ));
    }

    if(d.status === 'approved'){
      const cmtSection = el("div", {style:"grid-column:1/-1; margin-top:1rem; border-top:1px dashed #e5e7eb; padding-top:1rem"});
      const cmtList = el("div", {className:"grid", style:"gap:0.8rem; margin-bottom:0.8rem;"});
      const cmtForm = el("div",{className:"flex"},[
        el("input",{id:`cmt-${d.id}`, placeholder: state.user ? "Comentario..." : "Inicia sesi√≥n para comentar", disabled: !state.user, style:"flex:1"}),
        el("button",{
          textContent:"Enviar",
          disabled: !state.user,
          style: !state.user ? "opacity:0.5; background:gray;" : "",
          onclick: async () => {
            if(!state.user) return;
            const txt = qs(`#cmt-${d.id}`).value.trim();
            if(!txt) return;
            await supabase.from("comments").insert({ doc_id: d.id, user_id: state.user.id, author_name: state.user.email.split('@')[0], body: txt });
            loadComments(); qs(`#cmt-${d.id}`).value = "";
          }
        })
      ]);
      async function loadComments(){
        cmtList.innerHTML = "";
        const { data } = await supabase.from("comments").select("*").eq("doc_id", d.id).order("created_at",{ascending:false});
        if(data) data.forEach(c => {
          cmtList.append(el("div", {style:"background:#f9fafb; padding:0.5rem; border-radius:6px; font-size:0.9rem"}, [
            el("strong", {style:"color:var(--unam-blue)"}, c.author_name + ": "),
            el("span", {style:"color:#374151"}, c.body)
          ]));
        });
      }
      cmtSection.append(cmtList, cmtForm);
      row.append(cmtSection);
      loadComments();
    }
    return row;
  },

  modCard(d){
    const row = el("div", {className:"doc"});
    const { data: pub } = supabase.storage.from(BUCKET).getPublicUrl(d.storage_path);
    const info = el("div", {}, [
      el("div", {style:"font-weight:bold; color:var(--unam-blue)"}, d.title),
      el("div", {className:"muted"}, `Subido por: ${d.email || '?'}`),
      el("a", {href: pub.publicUrl, target:"_blank", style:"color:var(--unam-gold); font-weight:bold; text-decoration:underline;"}, "üìÇ Revisar")
    ]);
    const actions = el("div", {className:"grid"}, [
      el("button", {
        textContent: "‚úÖ Aprobar",
        onclick: async () => {
          if(!confirm("¬øAprobar?")) return;
          const oldPath = d.storage_path; 
          const fileName = oldPath.split("/").pop(); 
          const newPath = `public/${d.id}_${fileName}`; 
          const { error: moveErr } = await supabase.storage.from(BUCKET).move(oldPath, newPath);
          if(moveErr) return alert("Error storage: " + moveErr.message);
          
          await supabase.from("documents").update({ status: 'approved', storage_path: newPath, reject_reason: null }).eq("id", d.id);
          await supabase.from("notifications").insert({ user_id: d.owner, doc_id: d.id, type: 'accepted', message: `Aprobado: "${d.title}"` });
          pages.queue(); 
        }
      }),
      el("div", {className:"flex"}, [
        el("input", {id:`reason-${d.id}`, placeholder:"Raz√≥n de rechazo"}),
        el("button", {
          textContent: "‚ùå Rechazar", style: "background: var(--err); color:white;",
          onclick: async () => {
            const reason = qs(`#reason-${d.id}`).value.trim();
            if(!reason) return alert("Escribe motivo.");
            await supabase.from("documents").update({ status: 'rejected', reject_reason: reason }).eq("id", d.id);
            await supabase.from("notifications").insert({ user_id: d.owner, doc_id: d.id, type: 'rejected', message: `Rechazado: ${reason}` });
            pages.queue();
          }
        })
      ])
    ]);
    row.append(info, actions);
    return row;
  }
};

/*** SUBIDA ***/
const upload = {
  async submit(){
    if(!state.user) return alert("Inicia sesi√≥n.");
    const file = qs("#u_file").files[0];
    const title = qs("#u_title").value.trim();
    if(!file || !title) return alert("Falta archivo o t√≠tulo.");
    if(file.size > 5 * 1024 * 1024) return alert("M√°ximo 5MB.");

    qs("#u_msg").textContent = "Subiendo...";
    const safeName = file.name.replace(/[^a-zA-Z0-9.]/g, '_');
    const path = `pending/${state.user.id}/${Date.now()}-${safeName}`;
    const ext = file.name.split('.').pop();

    const { error: upErr } = await supabase.storage.from(BUCKET).upload(path, file);
    if(upErr){ qs("#u_msg").textContent="Error."; return alert(upErr.message); }

    const { error: dbErr } = await supabase.from("documents").insert({
      owner: state.user.id, title, author_name: qs("#u_author").value.trim(), 
      email: qs("#u_email").value.trim() || state.user.email,
      category: qs("#u_cat").value, tags: qs("#u_tags").value.split(","),
      ext, storage_path: path, size_bigint: file.size, status: 'pending'
    });

    if(dbErr) return alert(dbErr.message);
    alert("¬°Enviado a revisi√≥n!");
    qs("#u_msg").textContent = ""; qs("#u_title").value = ""; qs("#u_file").value = "";
    ui.show("mine");
  }
};

/*** INIT ***/
(function(){
  qs("#btn-login").onclick = authActions.signInPw;
  qs("#btn-signup").onclick = authActions.signUpPw;
  qs("#btn-magic").onclick = authActions.magicLink;
  qs("#btn-logout").onclick = authActions.signOut;
  qs("#btn-upload").onclick = upload.submit;
  // CORRECCI√ìN: Eliminado el listener del bot√≥n #btn-mod que ya no existe

  state.init().then(() => pages.search());
})();
</script>
</body>
</html>
