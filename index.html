<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Apuntes Escolares</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{--bg:#0f172a;--card:#111827;--muted:#9ca3af;--text:#e5e7eb;--accent:#22d3ee;--accent2:#38bdf8;--err:#f43f5e;--ok:#22c55e}
    *{box-sizing:border-box}body{margin:0;background:linear-gradient(180deg,#0b1023,#0f172a);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
    header,footer{border-color:rgba(255,255,255,.08)} header{position:sticky;top:0;background:rgba(15,23,42,.75);backdrop-filter:blur(6px);border-bottom:1px solid}
    .wrap{max-width:1100px;margin:0 auto;padding:1rem}
    .brand{font-weight:800}
    nav a{color:var(--text);opacity:.9;text-decoration:none;margin-right:1rem}
    .grid{display:grid;gap:1rem}
    .card{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.07);border-radius:14px;padding:1rem}
    input,select,textarea,button{border-radius:10px;border:1px solid rgba(255,255,255,.1);background:#0b1023;color:var(--text);padding:.6rem .8rem}
    button{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#00202a;border:none;font-weight:800;cursor:pointer}
    .pill{display:inline-block;border:1px solid rgba(255,255,255,.15);border-radius:999px;padding:.2rem .6rem;font-size:.75rem;color:var(--muted)}
    .flex{display:flex;gap:.6rem;align-items:center;flex-wrap:wrap}
    .right{margin-left:auto}
    .stars{font-size:1.1rem;cursor:pointer;user-select:none}
    .star-on{color:#ffd166}.star-off{color:#6b7280}
    .doc{display:grid;grid-template-columns:1fr auto;gap:.6rem;align-items:center;border-top:1px solid rgba(255,255,255,.06);padding:.7rem 0}
    .muted{color:var(--muted)} .err{color:var(--err)} .ok{color:var(--ok)} .hide{display:none}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:1rem} @media(max-width:880px){.two{grid-template-columns:1fr}}
  </style>
</head>

<body>
<header>
  <div class="wrap flex">
    <div class="brand">Apuntes Escolares</div>
    <nav class="right">
      <a href="#home" onclick="ui.show('home')">Inicio</a>
      <a href="#upload" onclick="ui.show('upload')">Subir</a>
      <a href="#mine" onclick="ui.show('mine')">Mis subidas</a>
      <a id="nav-mod" href="#moderation" onclick="ui.show('moderation')" class="hide">Moderaci√≥n</a>
    </nav>
  </div>
</header>

<main class="wrap grid">
  <section class="card" id="loginBox">
    <h2>Entrar</h2>
    <div class="two">
      <div>
        <h3>Como usuario</h3>
        <div class="grid">
          <input id="email" type="email" placeholder="tu@email.com" />
          <input id="password" type="password" placeholder="Contrase√±a (m√≠n. 8 caracteres)" />
          <div class="flex">
            <button id="btn-login">Entrar</button>
            <button id="btn-signup">Crear cuenta</button>
            <button id="btn-reset">Olvid√© mi contrase√±a</button>
          </div>
          <small class="muted">O entra con enlace m√°gico (sin contrase√±a):</small>
          <button id="btn-magic">Enviar enlace de acceso</button>
        </div>
      </div>
      <div>
        <h3>Como moderador</h3>
        <div class="grid">
          <button id="btn-mod">Ir al panel de moderaci√≥n</button>
          <small class="muted">Necesitas una cuenta con permisos de moderador.</small>
        </div>
      </div>
    </div>
    <div class="flex muted" style="margin-top:.5rem">
      <span class="pill">Tambi√©n puedes navegar como invitado (ver documentos y comentarios).</span>
      <span class="right" id="whoami">Invitado</span>
    </div>
  </section>

  <section class="card" id="home">
    <h2>Documentos aprobados</h2>
    <div class="two">
      <div class="grid">
        <input id="f_q" placeholder="Buscar por t√≠tulo o autor‚Ä¶" oninput="pages.search()" />
        <div class="flex">
          <select id="f_cat" onchange="pages.search()">
            <option value="">Todas las carreras</option>
            <option>Ingenier√≠a Civil</option><option>Ingenier√≠a Geom√°tica</option><option>Ingenier√≠a El√©ctrica Electr√≥nica</option>
            <option>Ingenier√≠a en Computaci√≥n</option><option>Ingenier√≠a en Telecomunicaciones</option><option>Ingenier√≠a Mec√°nica</option>
            <option>Ingenier√≠a Industrial</option><option>Ingenier√≠a Mecatr√≥nica</option><option>Ingenier√≠a en Sistemas Biom√©dicos</option>
          </select>
          <select id="f_ext" onchange="pages.search()">
            <option value="">Cualquier extensi√≥n</option><option>pdf</option><option>docx</option><option>pptx</option><option>png</option><option>jpg</option>
          </select>
          <select id="f_order" onchange="pages.search()">
            <option value="created_at.desc">M√°s recientes</option>
            <option value="avg_rating.desc">Mejor calificados</option>
            <option value="title.asc">T√≠tulo A‚ÜíZ</option>
          </select>
        </div>
      </div>
      <div class="grid">
        <input id="f_tags" placeholder="Etiquetas (coma , )" oninput="pages.search()" />
        <div class="flex">
          <label class="muted">Fecha desde</label><input type="date" id="f_from" onchange="pages.search()" />
          <label class="muted">hasta</label><input type="date" id="f_to" onchange="pages.search()" />
        </div>
      </div>
    </div>
    <div id="docsList" class="grid" style="margin-top:.8rem"></div>
  </section>

  <section class="card hide" id="upload">
    <h2>Subir documento (queda pendiente de aprobaci√≥n)</h2>
    <div class="grid">
      <input id="u_title" placeholder="T√≠tulo" />
      <input id="u_author" placeholder="Tu nombre (autor)" />
      <input id="u_email" placeholder="Tu correo (para notificaciones)" />
      <div class="two">
        <select id="u_cat">
          <option value="">Selecciona tu carrera</option>
          <option>Ingenier√≠a Civil</option><option>Ingenier√≠a Geom√°tica</option><option>Ingenier√≠a El√©ctrica Electr√≥nica</option>
          <option>Ingenier√≠a en Computaci√≥n</option><option>Ingenier√≠a en Telecomunicaciones</option><option>Ingenier√≠a Mec√°nica</option>
          <option>Ingenier√≠a Industrial</option><option>Ingenier√≠a Mecatr√≥nica</option><option>Ingenier√≠a en Sistemas Biom√©dicos</option>
        </select>
        <input id="u_tags" placeholder="Etiquetas separadas por coma (ej. C√°lculo, Integrales)" />
      </div>
      <input id="u_file" type="file" accept=".pdf,.doc,.docx,.ppt,.pptx,.png,.jpg,.jpeg" />
      <div class="flex">
        <button id="btn-upload">Enviar</button>
        <span id="u_msg" class="muted"></span>
      </div>
    </div>
  </section>

  <section class="card hide" id="mine">
    <h2>Mis subidas</h2>
    <div id="mineList" class="grid"></div>
  </section>

  <section class="card hide" id="moderation">
    <h2>Moderaci√≥n ‚Äì Pendientes</h2>
    <div id="modWarn" class="err"></div>
    <div id="queue" class="grid"></div>
  </section>

  <section class="card hide" id="notif">
    <h2>Notificaciones</h2>
    <div id="notifList" class="grid"></div>
  </section>
</main>

<footer>
  <div class="wrap flex">
    <span class="muted">¬© 2025 Apuntes Escolares</span>
    <div class="right flex">
      <button id="btn-logout">Salir</button>
    </div>
  </div>
</footer>

<script>
/**
 * ==========================================
 * CONFIGURACI√ìN DE SUPABASE
 * Reemplaza los placeholders con tus datos reales
 * ==========================================
 */
const SUPABASE_URL = "https://msoeeamotfajcpodnxif.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1zb2VlYW1vdGZhamNwb2RueGlmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0MjA2NDgsImV4cCI6MjA3ODk5NjY0OH0.fCas1O8XLgWwYww0l99VThswjWwlo_rGDOpMJ5Z_GXk";
const BUCKET = "DOCS";

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
  auth: {
    persistSession: true,
    autoRefreshToken: true,
    detectSessionInUrl: true
  }
});

/*** HELPERS UI ***/
const qs = s => document.querySelector(s);
const el = (t,a={},c=[])=>{const n=document.createElement(t);Object.entries(a).forEach(([k,v])=>(k in n)?n[k]=v:n.setAttribute(k,v));(Array.isArray(c)?c:[c]).filter(Boolean).forEach(x=>n.append(x.nodeType?x:document.createTextNode(x)));return n;}

const ui = {
  // Manejo de pesta√±as
  show(id){
    ["home","upload","mine","moderation","notif"].forEach(x => qs("#"+x).classList.toggle("hide", x!==id));
    if(id==="home") pages.search();
    if(id==="mine") pages.mine();
    if(id==="moderation") pages.queue();
    if(id==="notif") pages.notif();
  },
  
  // Render de estrellas
  stars(avg){ const n=Math.round(avg||0); return "‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ".split("").map((s,i)=> el("span",{className: i<n?"star-on":"star-off"}, s)); },
  
  // Actualiza la UI seg√∫n estado de autenticaci√≥n
  renderAuth(user, isModerator){
    const label = user ? `Conectado: ${user.email} ${isModerator ? '¬∑ MOD' : ''}` : "Invitado";
    qs("#whoami").textContent = label;
    
    // Si hay usuario, ocultamos el loginBox completo y mostramos bot√≥n Salir
    qs("#loginBox").classList.toggle("hide", !!user);
    qs("#btn-logout").classList.toggle("hide", !user);
    
    // Pesta√±a Moderaci√≥n solo si es admin
    qs("#nav-mod").classList.toggle("hide", !isModerator);
    
    // Si estamos en login y el usuario se conecta, enviarlo a home
    if(user && !qs("#loginBox").classList.contains("hide")) ui.show("home");
  }
};

/*** GESTI√ìN DE ESTADO (AUTH) ***/
const state = {
  user: null,
  isModerator: false,

  async init(){
    // 1. Obtener sesi√≥n inicial (Check de persistencia)
    const { data: { session } } = await supabase.auth.getSession();
    this.updateState(session);

    // 2. Escuchar cambios (Login, Logout, Token refresh)
    supabase.auth.onAuthStateChange((_event, session) => {
      this.updateState(session);
    });
  },

  updateState(session){
    this.user = session?.user || null;
    // Verificamos el claim is_moderator en app_metadata
    this.isModerator = !!(this.user?.app_metadata?.is_moderator);
    
    console.log("Auth State Updated:", { email: this.user?.email, isMod: this.isModerator });
    ui.renderAuth(this.user, this.isModerator);
  }
};

/*** L√ìGICA DE AUTH (Acciones) ***/
const REDIRECT_URL = window.location.origin + window.location.pathname;

const authActions = {
  async signInPw(){
    const email = qs("#email").value.trim();
    const password = qs("#password").value.trim();
    if(!email || !password) return alert("Falta correo o contrase√±a.");
    const { error } = await supabase.auth.signInWithPassword({ email, password });
    if(error) alert(error.message);
    else ui.show("home");
  },

  async signUpPw(){
    const email = qs("#email").value.trim();
    const password = qs("#password").value.trim();
    if(!email || !password) return alert("Falta correo o contrase√±a.");
    const { error } = await supabase.auth.signUp({
      email, password,
      options: { emailRedirectTo: REDIRECT_URL }
    });
    if(error) alert(error.message);
    else alert("Revisa tu correo para confirmar la cuenta.");
  },

  async magicLink(){
    const email = qs("#email").value.trim();
    if(!email) return alert("Escribe tu correo.");
    const { error } = await supabase.auth.signInWithOtp({
      email, options: { emailRedirectTo: REDIRECT_URL }
    });
    if(error) alert(error.message);
    else alert("Enlace enviado a tu correo.");
  },

  async signOut(){
    await supabase.auth.signOut();
    ui.show("home");
  }
};

/*** P√ÅGINAS Y DATOS ***/
const pages = {
  // B√∫squeda p√∫blica
  async search(){
    const q = qs("#f_q").value.trim();
    const cat = qs("#f_cat").value;
    const ext = qs("#f_ext").value;
    const tags = qs("#f_tags").value.split(",").map(s=>s.trim()).filter(Boolean);
    const order = qs("#f_order").value || "created_at.desc";
    const [col, dir] = order.split(".");

    let req = supabase.from("documents").select("*").eq("status","approved");
    
    if(q) req = req.or(`title.ilike.%${q}%,author_name.ilike.%${q}%`);
    if(cat) req = req.eq("category", cat);
    if(ext) req = req.eq("ext", ext);
    if(tags.length) req = req.contains("tags", tags);
    
    // Fechas
    const from = qs("#f_from").value;
    const to = qs("#f_to").value;
    if(from) req = req.gte("created_at", from);
    if(to) req = req.lte("created_at", to + " 23:59:59");

    req = req.order(col, { ascending: dir === "asc" });

    const { data, error } = await req;
    const box = qs("#docsList"); box.innerHTML = "";

    if(error) { box.textContent = "Error al cargar."; return; }
    if(!data?.length) { box.textContent = "No se encontraron documentos."; return; }

    data.forEach(d => box.append(render.docCard(d, { public: true })));
  },

  // Mis documentos
  async mine(){
    if(!state.user) return qs("#mineList").textContent = "Debes iniciar sesi√≥n.";
    
    const { data, error } = await supabase.from("documents")
      .select("*")
      .eq("owner", state.user.id)
      .order("created_at", { ascending: false });

    const box = qs("#mineList"); box.innerHTML = "";
    if(error) return box.textContent = "Error al cargar tus documentos.";
    if(!data?.length) return box.textContent = "No has subido nada a√∫n.";

    data.forEach(d => box.append(render.docCard(d, { mine: true })));
  },

  // Cola de moderaci√≥n
  async queue(){
    const box = qs("#queue"); box.innerHTML = "";
    if(!state.isModerator) return box.textContent = "Acceso denegado.";

    const { data, error } = await supabase.from("documents")
      .select("*")
      .eq("status", "pending")
      .order("created_at", { ascending: true });

    if(error) return box.textContent = "Error cargando cola.";
    if(!data?.length) return box.textContent = "Todo limpio. No hay pendientes.";

    data.forEach(d => box.append(render.modCard(d)));
  },

  // Notificaciones
  async notif(){
    if(!state.user) return qs("#notifList").textContent = "Inicia sesi√≥n.";
    
    const { data } = await supabase.from("notifications")
      .select("*")
      .eq("user_id", state.user.id)
      .order("created_at", { ascending: false });

    const box = qs("#notifList"); box.innerHTML = "";
    if(!data?.length) return box.textContent = "Sin notificaciones.";

    data.forEach(n => {
      const row = el("div", {className:"doc"}, [
        el("div", {}, [
          el("div", {style:"font-weight:bold"}, n.type === 'accepted' ? "‚úÖ Aprobado" : "‚ùå Rechazado"),
          el("div", {className:"muted"}, n.message)
        ]),
        el("div", {className:"muted"}, new Date(n.created_at).toLocaleDateString())
      ]);
      box.append(row);
    });
  }
};

/*** RENDERIZADO (Componentes) ***/
const render = {
  docCard(d, opts={}){
    const row = el("div",{className:"doc"});
    
    // URL P√∫blica (si est√° aprobado) o Privada (si es m√≠o/pendiente)
    // Para simplificar, usamos getPublicUrl, pero recuerda que 'pending' no ser√° accesible p√∫blicamente 
    // hasta que se mueva a 'public'.
    const { data: pub } = supabase.storage.from(BUCKET).getPublicUrl(d.storage_path);
    
    const left = el("div",{},[
      el("div",{style:"font-weight:700;font-size:1.1rem"}, d.title),
      el("div",{className:"muted"}, `${d.author_name||'An√≥nimo'} ‚Ä¢ ${d.category||'Gral'} ‚Ä¢ ${d.ext}`),
      el("div",{className:"pill", style:"margin-top:0.4rem"}, d.tags?.join(", ") || "Sin etiquetas")
    ]);

    const actions = el("div",{className:"grid", style:"justify-items:end; gap:0.5rem"});
    
    // Solo mostramos descargar si es p√∫blico o es m√≠o
    if(d.status === 'approved' || opts.mine){
      actions.append(el("a", {href: pub.publicUrl, target:"_blank", className:"pill"}, "‚¨á Descargar"));
    }
    
    // Estrellas
    const starsDiv = el("div", {className:"stars"}, ui.stars(d.avg_rating));
    if(state.user && d.status === 'approved'){
      starsDiv.onclick = async (e) => {
        // L√≥gica simple de votaci√≥n
        const idx = Array.from(e.currentTarget.children).indexOf(e.target);
        if(idx === -1) return;
        await supabase.from("ratings").upsert({ doc_id: d.id, user_id: state.user.id, stars: idx + 1 });
        pages.search(); // recargar para ver nuevo promedio
      };
    }
    actions.append(starsDiv);

    row.append(left, actions);

    // Si es "Mis subidas", mostrar estado
    if(opts.mine){
      let stColor = d.status === 'approved' ? 'ok' : (d.status==='rejected'?'err':'muted');
      let stText = d.status === 'approved' ? 'Aprobado' : (d.status==='rejected'?'Rechazado':'Pendiente');
      const statusRow = el("div", {className:`${stColor}`, style:"grid-column:1/-1; font-size:0.9rem"}, 
        `Estado: ${stText} ${d.reject_reason ? `(Motivo: ${d.reject_reason})` : ''}`
      );
      row.append(statusRow);
    }

    // Comentarios (solo si es vista p√∫blica approved)
    if(d.status === 'approved'){
      const cmtSection = el("div", {className:"grid", style:"grid-column:1/-1; margin-top:1rem; border-top:1px dashed #333; padding-top:0.5rem"});
      const cmtList = el("div", {className:"grid", style:"gap:0.5rem"});
      
      // Formulario comentario
      const cmtForm = el("div",{className:"flex"},[
        el("input",{id:`cmt-${d.id}`, placeholder:"Escribe un comentario...", style:"flex:1"}),
        el("button",{
          textContent:"Enviar",
          onclick: async () => {
            if(!state.user) return alert("Inicia sesi√≥n para comentar.");
            const txt = qs(`#cmt-${d.id}`).value.trim();
            if(!txt) return;
            await supabase.from("comments").insert({
              doc_id: d.id, 
              user_id: state.user.id, 
              author_name: state.user.email.split('@')[0], 
              body: txt
            });
            loadComments();
            qs(`#cmt-${d.id}`).value = "";
          }
        })
      ]);

      async function loadComments(){
        cmtList.innerHTML = "";
        const { data } = await supabase.from("comments").select("*").eq("doc_id", d.id).order("created_at",{ascending:false});
        if(data) data.forEach(c => {
          cmtList.append(el("div", {className:"muted", style:"font-size:0.85rem"}, [
            el("strong", {}, c.author_name + ": "),
            el("span", {}, c.body)
          ]));
        });
      }
      
      cmtSection.append(cmtList, cmtForm);
      row.append(cmtSection);
      loadComments(); // Carga inicial
    }

    return row;
  },

  modCard(d){
    const row = el("div", {className:"doc"});
    const { data: pub } = supabase.storage.from(BUCKET).getPublicUrl(d.storage_path);
    
    // Info
    const info = el("div", {}, [
      el("div", {style:"font-weight:bold"}, d.title),
      el("div", {className:"muted"}, `Subido por: ${d.email || '?'}`),
      el("div", {className:"muted"}, `Tags: ${d.tags?.join(", ")}`),
      el("a", {href: pub.publicUrl, target:"_blank", style:"color:var(--accent)"}, "üìÇ Ver Archivo (Vista previa)")
    ]);

    // Acciones
    const actions = el("div", {className:"grid"}, [
      el("button", {
        textContent: "‚úÖ Aprobar",
        onclick: async () => {
          if(!confirm("¬øAprobar y publicar este documento?")) return;
          
          // 1. Mover archivo: pending -> public
          const oldPath = d.storage_path; 
          const fileName = oldPath.split("/").pop(); // timestamp-nombre.pdf
          // Quitamos el timestamp para que quede limpio en public, o lo dejamos para unicidad. Dej√©moslo con ID del doc.
          const newPath = `public/${d.id}_${fileName.split('-').slice(1).join('-')}`; 

          const { error: moveErr } = await supabase.storage.from(BUCKET).move(oldPath, newPath);
          
          if(moveErr){
            console.error(moveErr);
            return alert("Error moviendo archivo en Storage: " + moveErr.message);
          }

          // 2. Actualizar DB
          await supabase.from("documents").update({
            status: 'approved',
            storage_path: newPath,
            reject_reason: null
          }).eq("id", d.id);

          // 3. Notificar
          await supabase.from("notifications").insert({
            user_id: d.owner,
            doc_id: d.id,
            type: 'accepted',
            message: `Tu documento "${d.title}" ha sido aprobado.`
          });

          pages.queue(); // Refrescar cola
        }
      }),
      el("div", {className:"flex"}, [
        el("input", {id:`reason-${d.id}`, placeholder:"Motivo rechazo"}),
        el("button", {
          textContent: "‚ùå Rechazar",
          style: "background: var(--err); color:white;",
          onclick: async () => {
            const reason = qs(`#reason-${d.id}`).value.trim();
            if(!reason) return alert("Debes indicar un motivo.");

            await supabase.from("documents").update({
              status: 'rejected',
              reject_reason: reason
            }).eq("id", d.id);

            await supabase.from("notifications").insert({
              user_id: d.owner,
              doc_id: d.id,
              type: 'rejected',
              message: `Rechazado: ${reason}`
            });

            pages.queue();
          }
        })
      ])
    ]);

    row.append(info, actions);
    return row;
  }
};

/*** SUBIDA DE ARCHIVOS ***/
const upload = {
  async submit(){
    if(!state.user) return alert("Debes iniciar sesi√≥n.");
    
    const fileInput = qs("#u_file");
    const file = fileInput.files[0];
    const title = qs("#u_title").value.trim();
    const cat = qs("#u_cat").value;
    const tags = qs("#u_tags").value.split(",").map(t=>t.trim()).filter(Boolean);
    const author = qs("#u_author").value.trim();
    const email = qs("#u_email").value.trim();

    if(!file || !title) return alert("Falta archivo o t√≠tulo.");
    if(file.size > 5 * 1024 * 1024) return alert("El archivo pesa m√°s de 5MB.");

    qs("#u_msg").textContent = "Subiendo archivo... espera...";

    // Ruta: pending/user_id/timestamp-filename
    const ext = file.name.split('.').pop();
    const safeName = file.name.replace(/[^a-zA-Z0-9.]/g, '_');
    const path = `pending/${state.user.id}/${Date.now()}-${safeName}`;

    // 1. Subir a Storage
    const { error: uploadErr } = await supabase.storage.from(BUCKET).upload(path, file);
    if(uploadErr){
      qs("#u_msg").textContent = "Error subiendo archivo.";
      return alert(uploadErr.message);
    }

    // 2. Crear registro en BD
    const { error: dbErr } = await supabase.from("documents").insert({
      owner: state.user.id,
      title,
      author_name: author,
      email: email || state.user.email,
      category: cat,
      tags,
      ext,
      storage_path: path,
      size_bigint: file.size,
      status: 'pending'
    });

    if(dbErr){
      qs("#u_msg").textContent = "Error guardando datos.";
      return alert(dbErr.message);
    }

    alert("¬°Subido! Esperando moderaci√≥n.");
    qs("#u_msg").textContent = "";
    // Limpiar form
    qs("#u_title").value = "";
    fileInput.value = "";
    ui.show("mine");
  }
};

/*** INICIALIZACI√ìN ***/
(function(){
  // Listeners de Auth
  qs("#btn-login").onclick = authActions.signInPw;
  qs("#btn-signup").onclick = authActions.signUpPw;
  qs("#btn-magic").onclick = authActions.magicLink;
  qs("#btn-logout").onclick = authActions.signOut;
  
  // Listener de Upload
  qs("#btn-upload").onclick = upload.submit;

  // Bot√≥n Mod
  qs("#btn-mod").onclick = () => {
    if(state.isModerator) ui.show("moderation");
    else alert("No tienes permisos.");
  };

  // Arrancar
  state.init().then(() => {
    // Si no hay sesi√≥n, mostramos home, si hay sesi√≥n state.init maneja la UI
    pages.search(); 
  });
})();
</script>
</body>
</html>
